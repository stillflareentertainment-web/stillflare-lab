<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MAAS · HR Risk Containment Advanced Model</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Favicon (placeholder) -->
  <link rel="icon" href="data:," />

  <!-- Chart.js for live graph -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* ==========
       Base layout
       ========== */
    :root {
      --bg: #020617;
      --bg-card: #020617;
      --border-soft: rgba(148, 163, 184, 0.28);
      --border-strong: rgba(148, 163, 184, 0.6);
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --accent: #38bdf8;
      --accent-soft: rgba(56, 189, 248, 0.12);
      --danger: #f97373;
      --success: #4ade80;
    }

    * {
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui,
        sans-serif;
    }

    body {
      margin: 0;
      min-height: 100vh;
      background: radial-gradient(circle at top, #0f172a 0, #020617 55%);
      color: var(--text-main);
      display: flex;
      align-items: stretch;
      justify-content: center;
      padding: 32px 12px;
    }

    .page {
      width: 100%;
      max-width: 1240px;
      margin: 0 auto;
      background: rgba(15, 23, 42, 0.92);
      border-radius: 24px;
      border: 1px solid var(--border-soft);
      box-shadow: 0 28px 80px rgba(0, 0, 0, 0.8);
      padding: 24px 22px 26px;
    }

    @media (max-width: 960px) {
      .page {
        padding: 18px 14px 22px;
      }
    }

    /* ==========
       Header
       ========== */
    .pill-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 10px;
    }

    .pill {
      font-size: 10px;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      color: var(--text-muted);
      background: rgba(15, 23, 42, 0.92);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .pill--accent {
      border-color: rgba(56, 189, 248, 0.7);
      color: #e0f2fe;
      background: linear-gradient(90deg, rgba(56, 189, 248, 0.32), transparent);
    }

    .pill-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 0 2px rgba(56, 189, 248, 0.48);
    }

    .title-wrap {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 12px;
      align-items: flex-end;
      margin-bottom: 10px;
    }

    h1 {
      margin: 0;
      font-size: 24px;
      letter-spacing: 0.03em;
    }

    .subtitle {
      margin: 4px 0 0;
      font-size: 13px;
      color: var(--text-muted);
      max-width: 640px;
    }

    .meta {
      text-align: right;
      font-size: 11px;
      color: var(--text-muted);
    }

    .meta strong {
      color: var(--text-main);
    }

    hr {
      border: none;
      border-top: 1px solid rgba(31, 41, 55, 0.9);
      margin: 16px 0 18px;
    }

    /* ==========
       Layout
       ========== */
    .grid {
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1.1fr);
      gap: 18px;
      align-items: stretch;
    }

    @media (max-width: 980px) {
      .grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      background: var(--bg-card);
      border-radius: 18px;
      border: 1px solid var(--border-soft);
      padding: 14px 14px 14px;
      box-shadow: 0 18px 50px rgba(15, 23, 42, 0.9);
    }

    .card + .card {
      margin-top: 10px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 6px;
    }

    .card-title {
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      color: var(--text-muted);
    }

    .card-sub {
      font-size: 11px;
      color: var(--text-muted);
    }

    /* ==========
       Inputs
       ========== */
    .field {
      margin-bottom: 8px;
    }

    .field-label-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
      margin-bottom: 2px;
      gap: 6px;
    }

    .field-label {
      color: var(--text-main);
    }

    .field-label span {
      color: var(--text-muted);
      font-size: 10px;
      margin-left: 4px;
    }

    .field-value {
      font-size: 11px;
      color: var(--text-muted);
    }

    input[type="range"] {
      width: 100%;
      accent-color: var(--accent);
    }

    .row-3 {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 8px;
    }

    .row-2 {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
    }

    @media (max-width: 640px) {
      .row-3 {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    .input {
      width: 100%;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: #020617;
      color: var(--text-main);
      font-size: 12px;
    }

    .textarea {
      width: 100%;
      padding: 6px 8px;
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: #020617;
      color: var(--text-main);
      font-size: 12px;
      resize: vertical;
      min-height: 68px;
    }

    .small-label {
      font-size: 11px;
      margin: 6px 0 2px;
      color: var(--text-muted);
    }

    /* ==========
       Buttons
       ========== */
    .button-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }

    .btn {
      border-radius: 999px;
      border: 1px solid transparent;
      padding: 6px 12px;
      font-size: 11px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      cursor: pointer;
      background: #2563eb;
      color: #f9fafb;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .btn-secondary {
      background: #020617;
      border-color: rgba(148, 163, 184, 0.6);
      color: var(--text-main);
    }

    .btn-small {
      padding: 4px 10px;
      font-size: 10px;
    }

    .toggle {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    /* ==========
       Metrics + Result cards
       ========== */
    .metric-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 6px;
      margin: 6px 0 6px;
    }

    .metric-card {
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      padding: 6px 7px;
      background: #020617;
    }

    .metric-label {
      font-size: 11px;
      color: var(--text-muted);
    }

    .metric-value {
      font-size: 13px;
      font-weight: 600;
      margin-top: 2px;
    }

    .metric-tag {
      display: block;
      font-size: 10px;
      color: #64748b;
      margin-top: 1px;
    }

    .metric-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 7px;
      border-radius: 999px;
      font-size: 10px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      margin-top: 4px;
    }

    .metric-badge--warn {
      border-color: rgba(248, 113, 113, 0.7);
      color: #fecaca;
      background: rgba(248, 113, 113, 0.14);
    }

    .metric-badge--ok {
      border-color: rgba(74, 222, 128, 0.7);
      color: #bbf7d0;
      background: rgba(34, 197, 94, 0.14);
    }

    /* ==========
       Callouts / footer
       ========== */
    .callout {
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      padding: 8px 9px;
      background: rgba(15, 23, 42, 0.9);
      font-size: 12px;
      color: var(--text-main);
      margin-top: 6px;
    }

    .callout small {
      display: block;
      font-size: 10px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .footer-legal {
      margin-top: 14px;
      font-size: 11px;
      color: var(--text-muted);
      border-top: 1px dashed rgba(55, 65, 81, 0.9);
      padding-top: 8px;
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 8px;
    }

    .footer-legal a {
      color: #9ca3af;
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="page">
    <!-- HEADER -->
    <div class="pill-row">
      <span class="pill">Status · Research Pilot</span>
      <span class="pill">Version · v0.3 Advanced</span>
      <span class="pill">Scope · Non-clinical</span>
      <span class="pill pill--accent">
        <span class="pill-dot"></span> MAAS · HR Risk Containment Engine
      </span>
    </div>

    <div class="title-wrap">
      <div>
        <h1>MAAS · HR Risk Containment Advanced Model</h1>
        <p class="subtitle">
          HR-only calculus-style model for coupled risk: functioning risk Rf(t), organizational risk Ro(t),
          containment C(t), and exposure E — with slider inputs, scenario tuning, and a live graph.
        </p>
      </div>
      <div class="meta">
        <div><strong>Stillflare Lab</strong></div>
        <div>MAAS-HR v0.3 &mdash; Advanced prototype</div>
      </div>
    </div>

    <hr />

    <!-- TOP HOW-TO CARD -->
    <div class="card" style="margin-bottom: 14px;">
      <div class="card-header">
        <div class="card-title">How to use · Solo guide</div>
        <div class="card-sub">Approx. 3–5 minutes per run</div>
      </div>
      <ol style="margin: 0 0 4px 16px; padding: 0; font-size: 12px; line-height: 1.5;">
        <li>Set the sliders to match how this period actually feels (drivers on the left, controls on the right).</li>
        <li>Enter starting risk levels Rf and Ro if you track them; otherwise keep the defaults.</li>
        <li>Choose the number of days to simulate and click <strong>Run Simulation</strong>.</li>
        <li>Read the <strong>Containment / Exposure metrics</strong> and the <strong>Driver &amp; Control focus</strong>.</li>
        <li>Adjust one or two sliders and re-run to explore “what if” scenarios. Take screenshots or export text for HR packets.</li>
      </ol>
      <div class="callout">
        Scope: MAAS-HR models only <strong>operational conditions</strong> (schedules, workload, communication,
        clarity, recovery). It does not measure or diagnose mental health, and it must not be used for
        clinical decision-making.
      </div>
    </div>

    <!-- MAIN GRID -->
    <div class="grid">
      <!-- LEFT: INPUTS -->
      <div>
        <div class="card">
          <div class="card-header">
            <div class="card-title">Inputs (0–10)</div>
            <div class="card-sub">Drivers = 0 low → 10 high · Controls = 0 weak → 10 strong</div>
          </div>

          <!-- DRIVERS -->
          <div class="field">
            <div class="field-label-row">
              <div class="field-label">
                SV – Schedule Variability <span>rotating shifts, unstable end-times</span>
              </div>
              <div class="field-value" id="valSV">5</div>
            </div>
            <input
              type="range"
              min="0"
              max="10"
              value="5"
              id="sv"
              data-label="SV – Schedule Variability (rotating shifts, unstable end-times)"
            />
          </div>

          <div class="field">
            <div class="field-label-row">
              <div class="field-label">
                WL – Workload Intensity <span>volume, pace, physical demand</span>
              </div>
              <div class="field-value" id="valWL">5</div>
            </div>
            <input
              type="range"
              min="0"
              max="10"
              value="5"
              id="wl"
              data-label="WL – Workload Intensity (volume, pace, physical demand)"
            />
          </div>

          <div class="field">
            <div class="field-label-row">
              <div class="field-label">
                CI – Communication Intensity <span>pressure, escalation</span>
              </div>
              <div class="field-value" id="valCI">5</div>
            </div>
            <input
              type="range"
              min="0"
              max="10"
              value="5"
              id="ci"
              data-label="CI – Communication Intensity (pressure, escalation)"
            />
          </div>

          <div class="field" style="margin-bottom: 10px;">
            <div class="field-label-row">
              <div class="field-label">
                NV – Notice Variability <span>last-minute changes, unclear timing</span>
              </div>
              <div class="field-value" id="valNV">5</div>
            </div>
            <input
              type="range"
              min="0"
              max="10"
              value="5"
              id="nv"
              data-label="NV – Notice Variability (last-minute changes, unclear timing)"
            />
          </div>

          <!-- CONTROLS -->
          <div class="field">
            <div class="field-label-row">
              <div class="field-label">
                CL – Clarity Controls <span>expectations, agendas, written protocols</span>
              </div>
              <div class="field-value" id="valCL">6</div>
            </div>
            <input
              type="range"
              min="0"
              max="10"
              value="6"
              id="cl"
              data-label="CL – Clarity Controls (expectations, agendas, written protocols)"
            />
          </div>

          <div class="field">
            <div class="field-label-row">
              <div class="field-label">
                PR – Process Reliability <span>channels, checklists, repeatability</span>
              </div>
              <div class="field-value" id="valPR">5</div>
            </div>
            <input
              type="range"
              min="0"
              max="10"
              value="5"
              id="pr"
              data-label="PR – Process Reliability (channels, checklists, repeatability)"
            />
          </div>

          <div class="field">
            <div class="field-label-row">
              <div class="field-label">
                RC – Recovery Compliance <span>breaks, reset time</span>
              </div>
              <div class="field-value" id="valRC">5</div>
            </div>
            <input
              type="range"
              min="0"
              max="10"
              value="5"
              id="rc"
              data-label="RC – Recovery Compliance (breaks, reset time)"
            />
          </div>

          <div class="row-3" style="margin-top: 8px;">
            <div>
              <div class="small-label">Initial Rf (functioning risk)</div>
              <input class="input" id="initRf" type="number" value="40" />
            </div>
            <div>
              <div class="small-label">Initial Ro (organizational risk)</div>
              <input class="input" id="initRo" type="number" value="35" />
            </div>
            <div>
              <div class="small-label">Days to simulate</div>
              <input class="input" id="simDays" type="number" value="60" />
            </div>
          </div>

          <div class="button-row">
            <button class="btn" id="runBtn" type="button">Run Simulation</button>
            <button class="btn btn-secondary" id="resetBtn" type="button">Reset</button>
            <label class="toggle">
              <input type="checkbox" id="liveToggle" />
              Live update as sliders move
            </label>
          </div>
        </div>

        <!-- HR TARGETS -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">HR Targets → Model Targets</div>
            <div class="card-sub">Describe the success window you care about.</div>
          </div>

          <div class="small-label">HR expectation (plain language)</div>
          <input
            class="input"
            id="hrExpectation"
            placeholder="Example: “Zero preventable incidents for the next 60 days.”"
          />

          <div class="row-3">
            <div>
              <div class="small-label">Evaluation window (days)</div>
              <input class="input" id="evalDays" type="number" value="60" />
            </div>
            <div>
              <div class="small-label">Target exposure reduction %</div>
              <input class="input" id="targetE" type="number" value="20" />
            </div>
            <div>
              <div class="small-label">Min containment C(t)</div>
              <input class="input" id="targetC" type="number" step="0.01" value="0.40" />
            </div>
          </div>
        </div>
      </div>

      <!-- RIGHT: RESULTS + GRAPH + NARRATIVE -->
      <div>
        <div class="card">
          <div class="card-header">
            <div class="card-title">Results</div>
            <div class="card-sub">Containment, exposure, and coupled risk paths</div>
          </div>

          <div class="metric-grid">
            <div class="metric-card">
              <div class="metric-label">Containment score C(t)</div>
              <div class="metric-tag">Closer to 1.0 = stronger containment</div>
              <div class="metric-value" id="metricC">0.000</div>
              <div class="metric-badge" id="badgeC">Not yet simulated</div>
            </div>

            <div class="metric-card">
              <div class="metric-label">Exposure E</div>
              <div class="metric-tag">Higher values = more sustained risk load</div>
              <div class="metric-value" id="metricE">0.0</div>
              <div class="metric-badge" id="badgeE">Not yet simulated</div>
            </div>

            <div class="metric-card">
              <div class="metric-label">Current Rf(t)</div>
              <div class="metric-tag">Functioning risk</div>
              <div class="metric-value" id="metricRf">0.0</div>
            </div>

            <div class="metric-card">
              <div class="metric-label">Current Ro(t)</div>
              <div class="metric-tag">Organizational risk</div>
              <div class="metric-value" id="metricRo">0.0</div>
            </div>
          </div>

          <div class="small-label">Top driver &amp; best control (auto)</div>
          <div class="row-2">
            <input class="input" id="topDriver" readonly />
            <input class="input" id="bestControl" readonly />
          </div>

          <div class="small-label" style="margin-top: 6px;">Live graph · Rf(t) and Ro(t) over the evaluation window</div>
          <div
            style="
              border-radius: 14px;
              border: 1px solid rgba(148, 163, 184, 0.7);
              background: radial-gradient(circle at top, #0b1220, #020617);
              padding: 8px;
              margin-top: 4px;
            "
          >
            <canvas id="riskChart" height="180"></canvas>
          </div>

          <div class="callout">
            <strong>Traffic-light reading (rule-of-thumb):</strong><br />
            • C(t) &lt; 0.30 → weak containment (red).<br />
            • 0.30–0.60 → partial containment (amber).<br />
            • &gt; 0.60 → strong containment (green).<br />
            Exposure E above ~1.0 suggests sustained pressure on staff.
          </div>
        </div>

        <!-- NARRATIVE / EXPORT -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">Narrative &amp; Export</div>
            <div class="card-sub">Packet-ready wording for HR / operations</div>
          </div>

          <div class="small-label">Narrative guidance (MAAS interpretation)</div>
          <textarea
            class="textarea"
            id="narrative"
            placeholder="Example: “C(t) remains in the partial containment range with elevated exposure E, driven primarily by workload intensity and schedule variability…”"
          ></textarea>

          <div class="small-label">Context notes (for packets, optional)</div>
          <textarea
            class="textarea"
            id="context"
            placeholder="- Month context: baseline vs. event-heavy&#10;- Key schedule / staffing changes&#10;- Any known HR actions or constraints"
          ></textarea>

          <div class="button-row">
            <button class="btn btn-secondary btn-small" id="copySummary" type="button">
              Copy plain-text summary
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- FOOTER / ETHICS -->
    <div class="footer-legal">
      <div>
        MAAS-HR is an <strong>HR / operations modeling tool</strong>. It supports decisions about schedule,
        workload, communication, clarity, and recovery. It must <strong>not</strong> be used for clinical
        diagnosis, medical decisions, or individual mental-health assessment.
      </div>
      <div>
        © 2025 Stillflare · MAAS-HR v0.3 Advanced · Licensed under the
        <a href="LICENSE">Stillflare Public Reference License (SPRL)</a>.
      </div>
    </div>
  </div>

  <script>
    // ===============================
    //  Data + helpers
    // ===============================
    const sliderIds = ["sv", "wl", "ci", "nv", "cl", "pr", "rc"];
    const sliderValueIds = {
      sv: "valSV",
      wl: "valWL",
      ci: "valCI",
      nv: "valNV",
      cl: "valCL",
      pr: "valPR",
      rc: "valRC"
    };

    const sliderLabels = {};
    sliderIds.forEach((id) => {
      const el = document.getElementById(id);
      sliderLabels[id] = el.getAttribute("data-label") || id.toUpperCase();
    });

    function clamp(v, min, max) {
      return Math.min(max, Math.max(min, v));
    }

    function getSliderValues() {
      const values = {};
      sliderIds.forEach((id) => {
        values[id] = Number(document.getElementById(id).value || 0);
      });
      return values;
    }

    // ===============================
    //  Chart setup
    // ===============================
    let riskChart = null;

    function initChart() {
      const ctx = document.getElementById("riskChart").getContext("2d");
      riskChart = new Chart(ctx, {
        type: "line",
        data: {
          labels: [],
          datasets: [
            {
              label: "Rf(t) · Functioning risk",
              data: [],
              borderWidth: 2,
              tension: 0.25
            },
            {
              label: "Ro(t) · Organizational risk",
              data: [],
              borderWidth: 2,
              borderDash: [5, 4],
              tension: 0.25
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              ticks: { color: "#9ca3af", font: { size: 10 } },
              grid: { color: "rgba(55,65,81,0.4)" },
              title: { display: true, text: "Day", color: "#9ca3af", font: { size: 11 } }
            },
            y: {
              min: 0,
              max: 100,
              ticks: { color: "#9ca3af", font: { size: 10 } },
              grid: { color: "rgba(55,65,81,0.4)" },
              title: {
                display: true,
                text: "Risk level (0–100)",
                color: "#9ca3af",
                font: { size: 11 }
              }
            }
          },
          plugins: {
            legend: {
              labels: { color: "#e5e7eb", font: { size: 10 } }
            }
          },
          elements: {
            point: { radius: 0 }
          }
        }
      });
    }

    // ===============================
    //  Simulation core (simple ODE-style)
    // ===============================
    function runSimulation() {
      const sliders = getSliderValues();
      const drivers = ["sv", "wl", "ci", "nv"];
      const controls = ["cl", "pr", "rc"];

      const driverSum = drivers.reduce((s, id) => s + sliders[id], 0);
      const controlSum = controls.reduce((s, id) => s + sliders[id], 0);

      const initRf = Number(document.getElementById("initRf").value || 0);
      const initRo = Number(document.getElementById("initRo").value || 0);
      let days = Number(document.getElementById("simDays").value || 1);
      days = clamp(days, 1, 365);

      // Containment and exposure
      let C = controlSum / (controls.length * 10); // 0–1
      let E = Math.max(0, (driverSum - controlSum / 1.3) / 10); // approx 0–10

      C = clamp(C, 0, 1);
      E = clamp(E, 0, 10);

      // Time evolution of Rf(t), Ro(t)
      const labels = [];
      const rfSeries = [];
      const roSeries = [];

      let rf = initRf;
      let ro = initRo;

      for (let t = 0; t <= days; t++) {
        labels.push(String(t));
        rfSeries.push(clamp(rf, 0, 100));
        roSeries.push(clamp(ro, 0, 100));

        // simple drift model:
        const driftDriver = E * 0.08; // upward pressure
        const driftControl = C * 0.12; // downward stabilizer

        rf = rf + driftDriver - driftControl;
        ro = ro + E * 0.05 - C * 0.08;
      }

      const finalRf = rfSeries[rfSeries.length - 1];
      const finalRo = roSeries[roSeries.length - 1];

      // Update chart
      if (!riskChart) initChart();
      riskChart.data.labels = labels;
      riskChart.data.datasets[0].data = rfSeries;
      riskChart.data.datasets[1].data = roSeries;
      riskChart.update();

      // Update metric cards
      document.getElementById("metricC").textContent = C.toFixed(3);
      document.getElementById("metricE").textContent = E.toFixed(1);
      document.getElementById("metricRf").textContent = finalRf.toFixed(1);
      document.getElementById("metricRo").textContent = finalRo.toFixed(1);

      // Badge logic
      const badgeC = document.getElementById("badgeC");
      const badgeE = document.getElementById("badgeE");

      if (C < 0.3) {
        badgeC.textContent = "Weak containment · high vulnerability";
        badgeC.className = "metric-badge metric-badge--warn";
      } else if (C < 0.6) {
        badgeC.textContent = "Partial containment · tighten structure";
        badgeC.className = "metric-badge";
      } else {
        badgeC.textContent = "Strong containment · protect what works";
        badgeC.className = "metric-badge metric-badge--ok";
      }

      if (E > 2) {
        badgeE.textContent = "High sustained exposure · monitor closely";
        badgeE.className = "metric-badge metric-badge--warn";
      } else if (E > 1) {
        badgeE.textContent = "Elevated exposure · review drivers";
        badgeE.className = "metric-badge";
      } else {
        badgeE.textContent = "Moderate / low exposure · maintain guardrails";
        badgeE.className = "metric-badge metric-badge--ok";
      }

      // Top driver / best control
      const topDriverId = drivers.reduce((best, id) =>
        sliders[id] > sliders[best] ? id : best
      );
      const bestControlId = controls.reduce((best, id) =>
        sliders[id] > sliders[best] ? id : best
      );

      const topDriverLabel = sliderLabels[topDriverId];
      const bestControlLabel = sliderLabels[bestControlId];

      document.getElementById("topDriver").value = topDriverLabel;
      document.getElementById("bestControl").value = bestControlLabel;

      // Autofill narrative if blank
      const narrativeEl = document.getElementById("narrative");
      if (!narrativeEl.value.trim()) {
        narrativeEl.value =
          "Model view: containment C(t) = " +
          C.toFixed(3) +
          ", exposure E = " +
          E.toFixed(1) +
          ". Functioning risk Rf(t) trends toward " +
          finalRf.toFixed(1) +
          " and organizational risk Ro(t) trends toward " +
          finalRo.toFixed(1) +
          " over " +
          days +
          " days. The primary operational pressure is " +
          topDriverLabel +
          ", while the highest leverage stabilizer is " +
          bestControlLabel +
          ". HR focus for this window should be to reduce driver pressure while strengthening this control before adding new initiatives.";
      }
    }

    function resetAll() {
      // Reset sliders
      const defaults = { sv: 5, wl: 5, ci: 5, nv: 5, cl: 6, pr: 5, rc: 5 };
      sliderIds.forEach((id) => {
        document.getElementById(id).value = defaults[id];
        document.getElementById(sliderValueIds[id]).textContent = defaults[id];
      });

      document.getElementById("initRf").value = 40;
      document.getElementById("initRo").value = 35;
      document.getElementById("simDays").value = 60;

      document.getElementById("hrExpectation").value = "";
      document.getElementById("evalDays").value = 60;
      document.getElementById("targetE").value = 20;
      document.getElementById("targetC").value = 0.4;

      document.getElementById("narrative").value = "";
      document.getElementById("context").value = "";

      document.getElementById("metricC").textContent = "0.000";
      document.getElementById("metricE").textContent = "0.0";
      document.getElementById("metricRf").textContent = "0.0";
      document.getElementById("metricRo").textContent = "0.0";
      document.getElementById("topDriver").value = "";
      document.getElementById("bestControl").value = "";

      document.getElementById("badgeC").textContent = "Not yet simulated";
      document.getElementById("badgeC").className = "metric-badge";
      document.getElementById("badgeE").textContent = "Not yet simulated";
      document.getElementById("badgeE").className = "metric-badge";

      if (riskChart) {
        riskChart.data.labels = [];
        riskChart.data.datasets[0].data = [];
        riskChart.data.datasets[1].data = [];
        riskChart.update();
      }
    }

    // ===============================
    //  Plain-text summary export
    // ===============================
    function buildPlainTextSummary() {
      const sliders = getSliderValues();
      const C = Number(document.getElementById("metricC").textContent || 0);
      const E = Number(document.getElementById("metricE").textContent || 0);
      const Rf = Number(document.getElementById("metricRf").textContent || 0);
      const Ro = Number(document.getElementById("metricRo").textContent || 0);

      const hrExpectation =
        document.getElementById("hrExpectation").value || "(not recorded)";
      const evalDays = document.getElementById("evalDays").value || "";
      const targetE = document.getElementById("targetE").value || "";
      const targetC = document.getElementById("targetC").value || "";
      const narrative = document.getElementById("narrative").value || "";
      const context = document.getElementById("context").value || "";

      const topDriver = document.getElementById("topDriver").value || "(not set)";
      const bestControl =
        document.getElementById("bestControl").value || "(not set)";

      const now = new Date().toLocaleString();

      let txt = "";
      txt +=
        "MAAS · HR Risk Containment Advanced Summary (Stillflare Lab)\n\n";
      txt += "Generated: " + now + "\n";
      txt +=
        "Model scope: HR / operations only — schedule, workload, communication, clarity, recovery.\n";
      txt +=
        "Not for clinical or medical decision-making; no mental-health diagnosis.\n\n";

      txt += "1) Model snapshot\n";
      txt += "   • Containment C(t): " + C + "\n";
      txt += "   • Exposure E: " + E + "\n";
      txt += "   • Rf(t) – functioning risk: " + Rf + "\n";
      txt += "   • Ro(t) – organizational risk: " + Ro + "\n\n";

      txt += "2) Operational sliders (0–10)\n";
      sliderIds.forEach((id) => {
        txt +=
          "   • " + sliderLabels[id] + ": " + sliders[id] + "/10\n";
      });
      txt += "\n";

      txt += "3) HR expectation & success window\n";
      txt += "   • HR expectation: " + hrExpectation + "\n";
      if (evalDays) txt += "   • Evaluation window: " + evalDays + " days\n";
      if (targetE) txt += "   • Target exposure reduction: " + targetE + "%\n";
      if (targetC)
        txt += "   • Minimum containment target C(t): " + targetC + "\n";
      txt += "\n";

      txt += "4) Driver & control focus\n";
      txt += "   • Highest pressure driver: " + topDriver + "\n";
      txt += "   • Most effective control lever: " + bestControl + "\n";
      txt +=
        "   • Practical reading: reduce risk first by strengthening this control lever before adding new policies, programs, or staff.\n\n";

      txt += "5) Narrative guidance (MAAS interpretation)\n";
      txt += narrative
        ? "   " + narrative + "\n\n"
        : "   (No narrative recorded.)\n\n";

      txt += "6) Additional context notes\n";
      txt += context ? "   " + context + "\n\n" : "   (None recorded.)\n\n";

      txt +=
        "Ethics note: MAAS-HR is an HR / operations model, not a clinical assessment. Use it to tune schedules, workload, communication, clarity, and recovery — not to label individuals.\n";
      txt += "—— End of MAAS-HR summary ——\n";

      return txt;
    }

    function copySummaryToClipboard() {
      const txt = buildPlainTextSummary();
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard
          .writeText(txt)
          .then(() => alert("Plain-text MAAS summary copied to clipboard."))
          .catch(() =>
            alert(
              "Clipboard access blocked. You can paste this text area into a document manually instead."
            )
          );
      } else {
        alert(
          "Clipboard API not available in this browser. Try selecting and copying from a text editor instead."
        );
      }
    }

    // ===============================
    //  Event wiring
    // ===============================
    document.addEventListener("DOMContentLoaded", () => {
      // Update numeric labels when sliders move
      sliderIds.forEach((id) => {
        const slider = document.getElementById(id);
        const valueLabel = document.getElementById(sliderValueIds[id]);
        slider.addEventListener("input", () => {
          valueLabel.textContent = slider.value;
          if (document.getElementById("liveToggle").checked) {
            runSimulation();
          }
        });
      });

      document.getElementById("runBtn").addEventListener("click", runSimulation);
      document
        .getElementById("resetBtn")
        .addEventListener("click", () => resetAll());
      document
        .getElementById("copySummary")
        .addEventListener("click", copySummaryToClipboard);

      resetAll();
    });
  </script>
</body>
</html>
